'''
Extract section fields in info file
'''
import ConfigParser
import csv
import json
import numpy as np
import os
import re
import string
import sys

#Helpter function: update dictionary [opcode, count]
def dictadd(dictionary,key):
    if key != "":
        if key in dictionary:
            dictionary[key] += 1
        else:
            dictionary[key] = 1

#Loading configuration file
Config = ConfigParser.ConfigParser()
Config.read("/home/amber/Malware/config")
rootdir = Config.get("Train","other") #Path to the section data
path_out = Config.get("Train","feature_save") #Path for saving extracted section fields

reload(sys)
sys.setdefaultencoding("UTF-8")   

dict_keys = []
dict_pool = []
z = []
count = 0

for subdir, dirs, files in os.walk(rootdir):
    sect = {}
    idx = ((subdir.rfind("/")))+1
    count +=1
    print(str(subdir[idx:])+str(" ")+str(count))
    sect["Filename"]=subdir[idx:].strip()

    for f in files:
        file = os.path.join(subdir, f)
        if(f=="sections"):
            with open((file),"rb") as sections:
                json_str = []
                for line in sections:
                    json_str.append(line)
                json_str = json_str[0].decode('utf-8', 'ignore').encode('utf-8')
                section = json.loads(json_str)
                     
                for item in section:
                    #Only these fields were useful and extracted
                    name = item["Name"]
                    name = name.replace('\x00', '')
                    name = name.replace(",",'')
                    entropy = item["Entropy"]
                    vSize = item["VirtualSize"]
                    rSize = item["RawSize"]
                    sect[str(name+"_entropy")] = entropy
                    sect[str(name+"_vSize")] = vSize
                    sect[str(name+"_rSize")] = rSize
                    dict_keys.extend(sect.keys())   
          
            z.append(sect)    

        dict_pool = list(set(dict_keys))

with open(os.path.join(path_out,"section_count"),'wb+') as f:
    w = csv.DictWriter(f,dict_pool,delimiter  = "\t")
    w.writeheader()
    c = 0
    for d in z:
        c+=1
        print("Writing file: "+str(c))
        w.writerow(d)



